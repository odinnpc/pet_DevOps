name: CI — Build Docker image and test nginx page

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Step 1 — Checkout repository code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Step 2 — Build Docker image from the Dockerfile
      - name: Build Docker image
        run: |
          docker build -t ped_devops:latest .

      # Step 3 — Run container and verify that nginx serves the expected page
      - name: Run nginx container and test page content
        run: |
          set -euo pipefail

          CONTAINER_NAME=ped_devops_test
          HOST_PORT=8080

          # Run container in detached mode and map port 8080 on the host to port 80 inside the container
          docker run --name "${CONTAINER_NAME}" -d -p "${HOST_PORT}:80" ped_devops:latest

          # Define cleanup function — it will run even if the test fails
          cleanup() {
            echo "=== Container logs ==="
            docker logs "${CONTAINER_NAME}" || true
            docker rm -f "${CONTAINER_NAME}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          # Wait up to 15 seconds for nginx to start
          echo "Waiting for nginx to start..."
          for i in $(seq 1 15); do
            if curl -sS "http://localhost:${HOST_PORT}" >/dev/null 2>&1; then
              echo "nginx responded (attempt $i)"
              break
            fi
            sleep 1
          done

          # Fetch the page content
          PAGE=$(curl -sS "http://localhost:${HOST_PORT}" || true)
          echo "Page content: ${PAGE}"

          # Check if the page contains the expected text
          if echo "${PAGE}" | grep -qF "ped_devops project"; then
            echo "✅ Test passed — page contains 'ped_devops project'"
          else
            echo "❌ Test failed — expected text not found on http://localhost:${HOST_PORT}"
            exit 1
          fi
